---
helmDefaults:
  # wait for k8s resources via --wait. (default false)
  wait: true
  # if set and --wait enabled, will wait until all Jobs have been completed before marking the release as successful. It will wait for as long as --timeout (default false, Implemented in Helm3.5)
  waitForJobs: true
  # time in seconds to wait for any individual Kubernetes operation (like Jobs for hooks, and waits on pod/pvc/svc/deployment readiness) (default 300)
  timeout: 600
  # forces resource update through delete/recreate if needed (default false)
  force: true

repositories:
  # democratic-csi
  - name: democratic-csi
    url: https://democratic-csi.github.io/charts/

releases:
  - name: cilium
    namespace: kube-system
    chart: oci://ghcr.io/home-operations/charts-mirror/cilium
    version: 1.18.4
    values:
      - templates/values.yaml.gotmpl
    hooks:
      # Wait for Cilium CRDs to be available
      - command: bash
        args:
          - -c
          - until kubectl get crd ciliumloadbalancerippools.cilium.io ciliumbgpadvertisements.cilium.io ciliumbgppeerconfigs.cilium.io ciliumbgpclusterconfigs.cilium.io &>/dev/null; do sleep 5; done
        events:
          - postsync
        showlogs: true
      # Apply cilium network configuration
      #- command: kubectl
        #args:
        #  - apply
        #  - --namespace=kube-system
        #  - --server-side
        #  - --field-manager=kustomize-controller
        #  - --kustomize
        #  - ../../apps/kube-system/cilium/config/
        #events:
        #  - postsync
        #showlogs: true


  #- name: democratic-csi
  #  namespace: storage
  #  chart: democratic-csi/democratic-csi
  #  version: 0.15.0
  #  values:
  #    - templates/values.yaml.gotmpl

  - name: flux-operator
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
    version: 0.33.0
    set:
      - name: crds.enabled
        value: "true"
    values:
      - templates/values.yaml.gotmpl
    needs:
      - kube-system/cilium

  - name: flux-instance
    namespace: flux-system
    chart: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance
    version: 0.33.0
    wait: false
    values:
      - templates/values.yaml.gotmpl
    needs:
      - flux-system/flux-operator
